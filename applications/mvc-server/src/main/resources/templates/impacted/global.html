<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Lyrical Impact</title>
        <meta charset="UTF-8"></meta>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"></meta>
        <!-- https://www.w3schools.com/w3css/tryit.asp?filename=tryw3css_templates_social&stacked=h -->
        <link rel="stylesheet" href="/css/w3.css"/>
        <link rel="stylesheet" href="/css/w3-theme-blue-grey.css"/>
        <link rel="stylesheet" href="/css/chartist.min.css"/>
        <script src="/js/chartist.min.js" type="text/javascript"></script>
        <script src="/webjars/jquery/3.4.1/jquery.min.js" type="text/javascript"></script>
        <style>
            html,body,h1,h2,h3,h4,h5 {font-family: "Open Sans", sans-serif}
        </style>
    </head>
    <body class="w3-theme-l5">
        <div th:replace="fragments/header :: header"></div>

        <!-- Page Container -->
        <div class="w3-container w3-content" style="max-width:1400px;margin-top:80px">    
            <!-- The Grid -->
            <div class="w3-row">
                <!-- Left Column -->
                <div class="w3-col m3">
                    <!-- Tags --> 
                    <div class="w3-card w3-round w3-white w3-hide-small">
                        <div class="w3-container">
                            <h3>Filter: Global verses by tag</h3>
                            <p>
                                <a class="w3-tag w3-small" th:classappend="${#strings.isEmpty(tag)}? 'w3-theme-l4' : 'w3-theme'" href="/global">[Show All]</a>
                                <a class="w3-tag w3-small" th:classappend="${tag == t.label}? 'w3-theme-l4' : 'w3-theme'" th:each="t : ${allTags}" th:text="${t.label}" th:href="|?tag=${t.label}|"/>
                            </p>
                        </div>
                    </div>
                    <br/>
                    <!-- Tag Donut Chart -->
                    <div class="w3-container w3-display-container w3-round w3-theme-l4 w3-border w3-theme-border w3-margin-bottom w3-hide-small">
                        <h3>Global tag distribution</h3>
                        <div class="ct-chart ct-square" style="padding-bottom:40px"></div>
                        <h5>You know... for kids!</h5>
                    </div>
                </div>
                <!-- Verses Column -->
                <div id="verses" class="w3-col m9">
                    
                    <div class="w3-row-padding">
                        <div class="w3-col m12">
                            <div class="w3-card w3-round w3-white">
                                <div class="w3-container w3-padding">
                                    <h3 th:text="'Globally impacting verses'"/>
                                    <button type="button" class="w3-button w3-theme"><a href="/my">Return to my impacted verses</a></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- no verses to show -->
                    <div class="w3-container w3-card w3-white w3-round w3-margin" th:if="${#lists.isEmpty(verses)}">
                        <h3 class="w3-opacity" th:if="${(param.q != null)}" th:text="'No verses match your search term &quot;' + ${param.q} + '&quot;.'">empty message</h3>
                        <h4 class="w3-opacity" th:if="${(param.q != null)}" th:text="'Try searching for something else or filtering with a tag.'">empty message</h4>
                        <h3 class="w3-opacity" th:if="${(param.tag != null)}" th:text="'Nobody has tagged any verses as &quot;' + ${param.tag} + '&quot;.'">empty message</h3>
                        <h4 class="w3-opacity" th:if="${(param.tag != null)}" th:text="'Try filtering for verses with another tag.'">empty message</h4>
                        <h3 class="w3-opacity" th:if="${(param.q == null) && (param.tag == null)}" th:text="'Nobody has added any verses. Add some of your own when you are ready.'">empty message</h3>
                    </div>

                    <!-- verses to show -->
                    <div th:replace="fragments/global-verses :: verses"></div>
                </div>
            </div>
        </div>
        <script>
            // aync load of tag metrics to render as a chart above
            var data = {
                labels: [],
                series: []
            };
            var options = {
                donut: true,
                donutWidth: 50,
                donutSolid: true,
                startAngle: 270,
                showLabel: true,
                chartPadding: 35,
                labelOffset: 35,
                labelDirection: 'explode'
            };
            var tagDonut = new Chartist.Pie('.ct-chart', data, options);

            $(document).ready(function() {
                $.ajax("/verses/metrics/tags", {
                    success:function(response) {
                        var data = response;
                        tagDonut.update(data);
                    },
                    failure:function(response) { }
                });
            });
        </script>
        <script>
            $.urlParam = function(name){
                var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
                return results ? results[1] : 0;
            };

            $(document).ready(function() {
                var win = $(window);
                var pageId = 1;
                var tag = $.urlParam('tag');
                var q = $.urlParam('q');
                var scrollParams = {
                    p: pageId
                };
                if (tag) {
                    scrollParams.tag = tag;
                } else if (q) {
                    scrollParams.q = q;                    
                }
                win.scroll(function() {
                    // End of the document reached?
                    if ($(document).height() - win.height() === win.scrollTop()) {
                        $.ajax({
                            url: 'global',
                            data: scrollParams,
                            dataType: 'html',
                            success: function(html) {
                                // console.log('---- scroll page loading ---- p[' + pageId + ']');
                                scrollParams.p = ++pageId;
                                $('#verses').append(html);
                            }
                        });
                    }
                });
            });
        </script>
            
    </body>

</html>
